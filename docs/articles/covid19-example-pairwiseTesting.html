<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="admix">
<title>covid19-pairwise-testing • admix</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="covid19-pairwise-testing">
<meta property="og:description" content="admix">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">admix</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/admixture-clustering.html">Clustering of unknown subpopulations in admixture models</a>
    <a class="dropdown-item" href="../articles/admixture-weight-estimation.html">Estimation of unknown elements in admixture models</a>
    <a class="dropdown-item" href="../articles/covid19-example-pairwiseTesting.html">covid19-pairwise-testing</a>
    <a class="dropdown-item" href="../articles/test-hypothesis.html">Hypothesis test in admixture models</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/XavierMilhaud/admix/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>covid19-pairwise-testing</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/XavierMilhaud/admix/blob/HEAD/vignettes/covid19-example-pairwiseTesting.Rmd" class="external-link"><code>vignettes/covid19-example-pairwiseTesting.Rmd</code></a></small>
      <div class="d-none name"><code>covid19-example-pairwiseTesting.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/XavierMilhaud/admix" class="external-link">admix</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Package 'admix' version 2.3.1</span></span>
<span><span class="co">#&gt; -------------------------------</span></span>
<span><span class="co">#&gt; Type 'citation("admix")' for citing this R package in publications.</span></span>
<span><span class="co">#&gt; -------------------------------</span></span>
<span><span class="co">#&gt; This work was partly conducted within the Research Chair DIALog under the aegis of the Risk Foundation, an initiative by CNP Assurances.</span></span></code></pre></div>
<p>There exists a wide variation in mortality related to COVID-19
pandemic across countries, leading to questioning the extent to which
one can proceed to pairwise comparative studies.</p>
<p>As exhibited by the Short-Term Mortality Fluctuations (STMF) dataset
from the Human Mortality Database (HMD), the all cause-of-death records
in European countries over the first 25 weeks shot up in 2020, as
compared to the historical corresponding mortality records exhibited
over the previous years. For instance, for France, Italy, Netherlands,
Belgium, Germany and Spain, we get:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">stmf_small</span><span class="op">)</span></span>
<span><span class="co">##### Data preparation:</span></span>
<span><span class="va">WEEKS</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">25</span>                                             <span class="co"># weeks of interest</span></span>
<span><span class="va">AGES</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"D15_64"</span>, <span class="st">"D65_74"</span>, <span class="st">"D75_84"</span>, <span class="st">"D85p"</span><span class="op">)</span>           <span class="co"># age classes of interest</span></span>
<span><span class="va">CNT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FRATNP"</span>, <span class="st">"ITA"</span>, <span class="st">"NLD"</span>, <span class="st">"BEL"</span>, <span class="st">"DEUTNP"</span>, <span class="st">"ESP"</span><span class="op">)</span>  <span class="co"># countries of interest</span></span>
<span><span class="va">Year_Benchmark</span> <span class="op">&lt;-</span> <span class="fl">2019</span>                                    <span class="co"># benchmark period</span></span>
<span><span class="co">## Death Records per age class, over years and weeks for males:</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">stmf_small</span>, <span class="op">(</span><span class="va">CountryCode</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">CNT</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Week</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">WEEKS</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Sex</span> <span class="op">==</span> <span class="st">"m"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">[</span> ,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CountryCode"</span>,<span class="st">"Year"</span>,<span class="st">"Week"</span>,<span class="va">AGES</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">## Aggregate data based on the three criteria 'Year', 'Country' and 'Week':</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape" class="external-link">reshape2</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: reshape2</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data.deaths</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">tmp</span>, id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>, <span class="st">"CountryCode"</span>, <span class="st">"Week"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data.deaths</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"YEAR"</span>,<span class="st">"COUNTRY"</span>,<span class="st">"WEEK"</span>, <span class="st">"AGE"</span>, <span class="st">"DEATH"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">##### Plot deaths per country over weeks:</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://lattice.r-forge.r-project.org/" class="external-link">lattice</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: lattice</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="http://had.co.nz/plyr" class="external-link">plyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: plyr</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">lattice</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span><span class="va">DEATH</span> <span class="op">~</span> <span class="va">WEEK</span> <span class="op">|</span> <span class="va">COUNTRY</span>,</span>
<span>                groups <span class="op">=</span> <span class="va">YEAR</span>,</span>
<span>                data <span class="op">=</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html" class="external-link">ddply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data.deaths</span>, <span class="va">YEAR</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">Year_Benchmark</span><span class="op">:</span><span class="fl">2020</span><span class="op">)</span>,</span>
<span>                                   <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/quoted.html" class="external-link">.</a></span><span class="op">(</span><span class="va">WEEK</span>, <span class="va">COUNTRY</span>, <span class="va">YEAR</span><span class="op">)</span>,</span>
<span>                                   <span class="va">summarize</span>,</span>
<span>                                   DEATH <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">DEATH</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray"</span>, <span class="st">"black"</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">"Week"</span>, ylab <span class="op">=</span> <span class="st">"Death Records"</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                scales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rot <span class="op">=</span> <span class="fl">45</span>, cex <span class="op">=</span> <span class="fl">.8</span>,</span>
<span>                                       labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"W"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">WEEKS</span><span class="op">)</span>,by<span class="op">=</span><span class="fl">3</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">''</span><span class="op">)</span>,</span>
<span>                                       at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">WEEKS</span><span class="op">)</span>, by<span class="op">=</span><span class="fl">3</span><span class="op">)</span>, alternating <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>,</span>
<span>                              y <span class="op">=</span> <span class="st">"free"</span>, tck <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                par.settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                  superpose.polygon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"black"</span>, border<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span>,</span>
<span>                  strip.background <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span>,</span>
<span>                  strip.border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                par.strip.text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, font <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="covid19-example-pairwiseTesting_files/figure-html/fig1-1.png" width="624" style="display: block; margin: auto;"></p>
<p>On top of this, the mortality profile itself has been largely
distorted by the sanitary crisis. Basically, elderly people have been
more severely impacted than other classes of age. This is illustrated by
the coming Figure:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Aggregate data over weeks per age group:</span></span>
<span><span class="va">data.deaths</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html" class="external-link">ddply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data.deaths</span>, <span class="va">YEAR</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">Year_Benchmark</span><span class="op">:</span><span class="fl">2020</span><span class="op">)</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/quoted.html" class="external-link">.</a></span><span class="op">(</span><span class="va">AGE</span>, <span class="va">COUNTRY</span>, <span class="va">YEAR</span><span class="op">)</span>,</span>
<span>                           <span class="va">summarize</span>,</span>
<span>                           DEATH <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">DEATH</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##### Preparing data for the hypothesis testing:</span></span>
<span><span class="va">data.d</span> <span class="op">&lt;-</span> <span class="va">stat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">probs_countries</span> <span class="op">&lt;-</span> <span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">CNT</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## Loop on each country:</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">CNT</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> ; <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data.deaths</span>, <span class="va">AGE</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">AGES</span><span class="op">)</span></span>
<span>  <span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="co">## On a given country, sum for each year the number of deaths in each age class:</span></span>
<span>  <span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/cast.html" class="external-link">dcast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="va">COUNTRY</span> <span class="op">==</span> <span class="va">CNT</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="va">YEAR</span> <span class="op">~</span> <span class="va">AGE</span>, value.var <span class="op">=</span> <span class="st">"DEATH"</span>,</span>
<span>                                   fun.aggregate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">L</span> <span class="op">&lt;-</span> <span class="va">CNT</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>  <span class="co"># name of the country</span></span>
<span>  <span class="co">## On a given country, sum for each age class the number of deaths in each year:</span></span>
<span>  <span class="va">cs</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/cast.html" class="external-link">dcast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data.deaths</span>, <span class="va">COUNTRY</span> <span class="op">==</span> <span class="va">CNT</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="va">AGE</span> <span class="op">~</span> <span class="va">YEAR</span> , value.var <span class="op">=</span> <span class="st">"DEATH"</span>,</span>
<span>                        fun.aggregate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">stat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">stat</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">cs</span><span class="op">[</span> ,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, Geo <span class="op">=</span> <span class="va">CNT</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">cs</span><span class="op">$</span><span class="va">AGE</span></span>
<span>  <span class="co">## Compute the probability to be in each age class when someone pass away:</span></span>
<span>  <span class="va">cs</span><span class="op">[</span> ,<span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cs</span><span class="op">[</span> ,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">cs</span><span class="op">[</span> ,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="va">data.d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">data.d</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">cs</span>, id <span class="op">=</span> <span class="st">"AGE"</span><span class="op">)</span>, COUNTRY <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">CNT</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## Boolean vector to get the benchmark year:</span></span>
<span>  <span class="va">years</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">$</span><span class="va">YEAR</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">Year_Benchmark</span><span class="op">)</span></span>
<span>  <span class="co">## Benchmark mortality profile by age class (multinomial probabilities for age class death);</span></span>
<span>  <span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">years</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">years</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## Format data about events (deaths) for the multinomial distributions for each year (2019 and 2020):</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">$</span><span class="va">YEAR</span> <span class="op">==</span> <span class="va">Year_Benchmark</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">sim19</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">sim</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="op">}</span> <span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">$</span><span class="va">YEAR</span> <span class="op">==</span> <span class="st">"2020"</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">sim20</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">sim</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="op">}</span> <span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="va">probs_countries</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sim20 <span class="op">=</span> <span class="va">sim20</span>, sim19 <span class="op">=</span> <span class="va">sim19</span>, probs <span class="op">=</span> <span class="va">probs</span>, L <span class="op">=</span> <span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">L</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data.d</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AGE"</span>, <span class="st">"YEAR"</span>, <span class="st">"DEATH"</span>, <span class="st">"COUNTRY"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Plot multinomial distribution in 2019 and 2020 for each country:</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">barchart</a></span><span class="op">(</span><span class="va">DEATH</span> <span class="op">~</span> <span class="va">AGE</span> <span class="op">|</span> <span class="va">COUNTRY</span>,</span>
<span>         groups <span class="op">=</span> <span class="va">YEAR</span>,</span>
<span>         data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data.d</span>, <span class="op">(</span><span class="va">YEAR</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2019</span><span class="op">:</span><span class="fl">2020</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">COUNTRY</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">CNT</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">AGE</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">AGES</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray"</span>,<span class="st">"black"</span><span class="op">)</span>,</span>
<span>         scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rot <span class="op">=</span> <span class="fl">45</span>, alternating <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, y <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span>,</span>
<span>         xlab <span class="op">=</span> <span class="st">"Age Group"</span>, ylab <span class="op">=</span> <span class="st">"Death Distribution"</span>,</span>
<span>         par.settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>           superpose.polygon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"black"</span>, border <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,</span>
<span>           strip.background <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>           strip.border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         par.strip.text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, font <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="covid19-example-pairwiseTesting_files/figure-html/fig2-1.png" width="624" style="display: block; margin: auto;"></p>
<p>Such a phenomenon can be interpreted as a contamination of some
well-known/regular random behaviour (described here by the mortality
distribution) and modelled by using a specific mixture model with
cumulative distribution function (cdf) <span class="math inline">\(L\)</span>, given by <span class="math display">\[L_i(x) = p_iF_i(x) + (1-p_i)G_i(x), \qquad x \in
\mathbb{R},\]</span> where <span class="math inline">\(G_i\)</span> is a
mixture component whose distribution is perfectly known for country
<span class="math inline">\(i\)</span> (mortality distribution over ages
in 2019), whereas <span class="math inline">\(p_i\)</span> and <span class="math inline">\(F_i\)</span> are unknown.</p>
<p>The goal of this vignette is to look at the nodular impact of the
COVID-19 and compare the latter across a panel of European countries.
For this, we will first capture the regular mortality profile for each
country <span class="math inline">\(i\)</span>, represented by the cdf
<span class="math inline">\(G_i\)</span>. More precisely, in this
application, we consider an event <span class="math inline">\(A\)</span>
indicating whether the COVID-19 pandemic has impacted (directly or
indirectly) some given individual, and <span class="math inline">\(X\)</span> the random variable indicating the age
category for a dead person picked at random during the 25 first week of
2020. Here, <span class="math inline">\(X\)</span> is labeled from 1 to
4 (#1=[15-64], #2=[65,74], #3=[75,84], #4=[85,+[). Considering that
during the early times of the COVID-19 pandemic, because of the sudden
nature of the crisis and the lack of preparation of the countries, all
the populations were uniformly (in age) exposed to the virus, we propose
to define the cumulative distribution function of <span class="math inline">\(X\)</span> by using the following Bayes principle:
<span class="math display">\[\begin{eqnarray}\label{COVID-19}
    L(k)=P(X\leq k)&amp;=&amp;P(\bar A) P(X\leq k\;|~\bar A)+P(A)
P(X\leq k\;|~A) \nonumber  \\
                  &amp;=&amp; (1-p)G(k)+pF(k),\quad\quad k=1,\dots,4,
\end{eqnarray}\]</span> where the probability <span class="math inline">\(p=P(A)\)</span> of being impacted by COVID-19 is
unknown, the probability of death occurring before class <span class="math inline">\(k\)</span> given the fact that the person died
from a regular cause, i.e. <span class="math inline">\(G(k) = P(X \leq
k\;| \;\bar A)\)</span>, is known and represents the regular per age
mortality distribution, whereas the probability of death happening
before class <span class="math inline">\(k\)</span> given the fact that
the person died prematurely from consequences of the COVID-19 pandemic,
i.e. <span class="math inline">\(F(k) = P(X\leq k \;| \; A)\)</span> is
unknown. Given this modelling of the mortality distribution distortion
effect due to the pandemic, we propose to test if some of the European
countries included in our panel reacted similarly in terms of mortality
over ages in the early stage of the pandemic, or equivalently if some
countries had similar <span class="math inline">\(F\)</span>’s
components involved in their contamination model.</p>
<p>We now proceed to the pairwise testing across the six countries using
the Inversion Best-Matching (IBM) method (warning: you need some time to
perform this step, at least ten minutes depending on your machine):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## First, define a function that allows to get the decontaminated version (Inversion step) of the unknown CDF Fi:</span></span>
<span><span class="va">decontaminated_theoCDF</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span>, <span class="va">COUNTRY</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">CNT</span> <span class="op">==</span> <span class="va">COUNTRY</span><span class="op">)</span></span>
<span>  <span class="va">G.probs</span> <span class="op">&lt;-</span> <span class="va">probs_countries</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probs</span></span>
<span>  <span class="va">L.probs</span> <span class="op">&lt;-</span> <span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">$</span><span class="va">YEAR</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sample</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">X</span><span class="op">$</span><span class="va">YEAR</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">G.X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html" class="external-link">stepfun</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">G.probs</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">G.probs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">L.X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html" class="external-link">stepfun</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">L.probs</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">L.probs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">FX</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">{</span> <span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">p</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fu">L.X</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span> <span class="op">*</span> <span class="fu">G.X</span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span>  <span class="va">F.X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html" class="external-link">stepfun</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">G.probs</span><span class="op">)</span>, <span class="fu">FX</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>FX <span class="op">=</span> <span class="va">F.X</span>, GX <span class="op">=</span> <span class="va">G.X</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Then proceed to the pairwise testing of effects across all countries:</span></span>
<span><span class="va">pairwise_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">CNT</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">CNT</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">counter</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">a</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">CNT</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="op">(</span><span class="va">a</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">CNT</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X.sim</span> <span class="op">&lt;-</span> <span class="va">Y.sim</span> <span class="op">&lt;-</span> <span class="va">estim_prop</span> <span class="op">&lt;-</span> <span class="va">U.H0</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="va">X.sim</span> <span class="op">&lt;-</span> <span class="va">probs_countries</span><span class="op">[[</span><span class="va">a</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sim20</span></span>
<span>    <span class="va">admixMod.X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/admix_model.html">admix_model</a></span><span class="op">(</span>knownComp_dist <span class="op">=</span> <span class="st">"multinom"</span>, </span>
<span>                              knownComp_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"size"</span><span class="op">=</span><span class="fl">1</span>, <span class="st">"prob"</span> <span class="op">=</span> <span class="va">probs_countries</span><span class="op">[[</span><span class="va">a</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probs</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">Y.sim</span> <span class="op">&lt;-</span> <span class="va">probs_countries</span><span class="op">[[</span><span class="va">b</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sim20</span></span>
<span>    <span class="va">admixMod.Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/admix_model.html">admix_model</a></span><span class="op">(</span>knownComp_dist <span class="op">=</span> <span class="st">"multinom"</span>, </span>
<span>                              knownComp_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"size"</span><span class="op">=</span><span class="fl">1</span>, <span class="st">"prob"</span> <span class="op">=</span> <span class="va">probs_countries</span><span class="op">[[</span><span class="va">b</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probs</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">estim_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estim_IBM.html">estim_IBM</a></span><span class="op">(</span>samples <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">X.sim</span>,<span class="va">Y.sim</span><span class="op">)</span>, admixMod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">admixMod.X</span>,<span class="va">admixMod.Y</span><span class="op">)</span>, n.integ <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">estim_prop</span><span class="op">$</span><span class="va">estimated_mixing_weights</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">U.H0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/IBM_tabul_stochasticInteg.html">IBM_tabul_stochasticInteg</a></span><span class="op">(</span>n.sim <span class="op">=</span> <span class="fl">30</span>, n.varCovMat <span class="op">=</span> <span class="fl">50</span>, samples <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">X.sim</span>, <span class="va">Y.sim</span><span class="op">)</span>,</span>
<span>                                        admixMod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">admixMod.X</span>,<span class="va">admixMod.Y</span><span class="op">)</span>, </span>
<span>                                        min_size <span class="op">=</span> <span class="cn">NULL</span>, parallel <span class="op">=</span> <span class="cn">FALSE</span>, n_cpu <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="va">res_test</span> <span class="op">&lt;-</span> <span class="va">decision</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>      <span class="va">res_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/IBM_k_samples_test.html">IBM_k_samples_test</a></span><span class="op">(</span>samples <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">X.sim</span>,<span class="va">Y.sim</span><span class="op">)</span>, admixMod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">admixMod.X</span>,<span class="va">admixMod.Y</span><span class="op">)</span>,</span>
<span>                                    sim_U <span class="op">=</span> <span class="va">U.H0</span><span class="op">$</span><span class="va">U_sim</span>, n_sim_tab <span class="op">=</span> <span class="fl">50</span>, conf_level <span class="op">=</span> <span class="fl">0.95</span>, parallel<span class="op">=</span><span class="cn">FALSE</span>, n_cpu<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="va">decision</span> <span class="op">&lt;-</span> <span class="va">res_test</span><span class="op">$</span><span class="va">reject_decision</span></span>
<span>      <span class="co">## Decontaminated CDF:</span></span>
<span>      <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>AGE <span class="op">=</span> <span class="va">AGES</span>,</span>
<span>              A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu">decontaminated_theoCDF</span><span class="op">(</span><span class="va">estim_prop</span><span class="op">$</span><span class="va">estimated_mixing_weights</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">probs_countries</span><span class="op">[[</span><span class="va">a</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">L</span><span class="op">)</span><span class="op">$</span><span class="fu">FX</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>              B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu">decontaminated_theoCDF</span><span class="op">(</span><span class="va">estim_prop</span><span class="op">$</span><span class="va">estimated_mixing_weights</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">probs_countries</span><span class="op">[[</span><span class="va">b</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">L</span><span class="op">)</span><span class="op">$</span><span class="fu">FX</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>countries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">probs_countries</span><span class="op">[[</span><span class="va">a</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">L</span>,<span class="va">probs_countries</span><span class="op">[[</span><span class="va">b</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">L</span><span class="op">)</span>,</span>
<span>                weights <span class="op">=</span> <span class="va">estim_prop</span><span class="op">$</span><span class="va">estimated_mixing_weights</span>,</span>
<span>                q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">U.H0</span><span class="op">)</span>, <span class="st">"Test red light"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">U.H0</span><span class="op">$</span><span class="va">U_sim</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                test <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">U.H0</span><span class="op">)</span>, <span class="st">"Test red light"</span>, <span class="va">decision</span><span class="op">)</span>,</span>
<span>                decontamin <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">pairwise_res</span><span class="op">[[</span><span class="va">counter</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">obj</span></span>
<span>    <span class="va">counter</span> <span class="op">&lt;-</span> <span class="va">counter</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>It is now time to compare the decontaminated versions of the unknown
densities <span class="math inline">\(F_i\)</span> over countries for
which the null hypothesis has not been rejected, leading to similar
mortality distortions due to COVID-19 pandemic:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Decontaminated CDFs comparison for all similar effects:</span></span>
<span><span class="va">index.decontamin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">pairwise_res</span>, <span class="st">"[["</span>, <span class="st">"test"</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">list.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">index.decontamin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: gridExtra</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">index.decontamin</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">pairwise_res</span><span class="op">[[</span><span class="va">index.decontamin</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">decontamin</span></span>
<span>  <span class="va">list.plot</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">barchart</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>,</span>
<span>                             <span class="va">A</span> <span class="op">+</span> <span class="va">B</span> <span class="op">~</span> <span class="va">AGE</span>,</span>
<span>                             par.settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/simpleTheme.html" class="external-link">simpleTheme</a></span><span class="op">(</span>col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey80"</span>, <span class="st">"grey20"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                             ylab <span class="op">=</span> <span class="st">"Death Distribution"</span>,</span>
<span>                             auto.key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">pairwise_res</span>, <span class="st">"[["</span>, <span class="st">"countries"</span><span class="op">)</span><span class="op">[</span> ,<span class="va">index.decontamin</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                                             space <span class="op">=</span> <span class="st">"top"</span>, columns <span class="op">=</span> <span class="fl">2</span>, cex.title <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">expr.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"list.plot[["</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">index.decontamin</span><span class="op">)</span>, <span class="st">"]]"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">expr.plot</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="covid19-example-pairwiseTesting_files/figure-html/fig3-1.png" width="672" style="display: block; margin: auto;"></p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Xavier Milhaud.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
